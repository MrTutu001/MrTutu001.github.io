<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--Page Info-->
    <title>Light Rewrite</title>
    <link rel="icon" href="lightRewriteIconBlack.ico" type="image/x-icon">
    <!-- Imports -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
        }
        h1 {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon {
            width: 30px; /* Adjust size of the icon */
            height: 30px;
            margin: 0 10px; /* Space between text and image */
        }
        .mirrored {
            transform: scaleX(-1); /* Mirroring the right image */
        }
        .menu-bar { 
            background-color: #f0f0f0; 
            padding: 10px; 
            display: flex; /* Use flex to align items */
            justify-content: flex-start; /* Align items to the left */
            width: 100%; /* Make menu bar full width */
            box-shadow: 0px 2px 5px rgba(0,0,0,0.2); /* Add slight shadow for depth */
            margin-bottom: 10px; /* Space below the menu */
        }
        .dropdown {
            position: relative; /* Position relative to the menu items */
            margin-right: 15px; /* Space between dropdowns */
        }
        .dropdown-content {
            display: none; 
            position: absolute; 
            background-color: white; 
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            white-space: nowrap; /* Prevent wrapping */
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .file-upload, .search-option { margin: 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 12px; border: 1px solid #ddd; }
        .dropdown-content a { padding: 8px 12px; display: block; text-decoration: none; }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .instruction { 
            text-align: center; 
            margin-bottom: 20px; 
            font-style: italic; 
            color: #555; 
            display: block; 
        }
        #searchInfo { 
            text-align: center; 
            margin-bottom: 10px; 
            font-weight: bold; 
            color: #007BFF; 
        }
    </style>
</head>
<body>

    <h1> <!--Title-->
        <img src="lightRewriteIconBlack.ico" alt="Left Icon" class="icon">
        Light Rewrite Web
        <img src="lightRewriteIconBlack.ico" alt="Right Icon" class="icon mirrored">
    </h1>

<div class="menu-bar"> <!--Menu Bar-->
    <div class="dropdown">
        <button>File</button>
        <div class="dropdown-content">
            <label for="fileInput" class="file-upload">
                <input type="file" id="fileInput" accept=".xml" style="display: none;" onchange="processFile()">
                <a href="#" onclick="document.getElementById('fileInput').click(); return false;">Upload XML File</a>
            </label>
            <div class="showInfo">
                <a href="#" onclick="getShowInfo()">Show Info</a>
            </div>
        </div>
    </div>

    <div class="dropdown">
        <button>Tools</button>
        <div class="dropdown-content">
            <div class="tools">
                <a href="#" onclick="populateAddressFromDimmer()">Dimmer to Address</a>
            </div>
        </div>
    </div>
    
    <div class="dropdown">
        <button>Search</button>
        <div class="dropdown-content">
            <div class="search-option">
                <a href="#" onclick="searchByChannel()">Channel</a>
            </div>
            <div class="search-option">
                <a href="#" onclick="searchByAddress()">Address</a>
            </div>
            <div class="search-option">
                <a href="#" onclick="searchByPosition()">Position</a>
            </div>
            <div class="search-option">
                <a href="#" onclick="resetSearch()">Reset</a> <!-- Reset option added -->
            </div>
        </div>
    </div>

    <div class="dropdown">
        <button>Exports</button>
        <div class="dropdown-content">
            <div class="exports">
                <a href="#" onclick="exportChannelHookup()">Channel Hookup</a>
            </div>
            <div class="exports">
                <a href="#" onclick="exportInstrumentSchedule()">Instrument Schedule</a>
            </div>
            <div class="exports">
                <a href="#" onclick="exportColorCount()">Color Count</a>
            </div>
            <div class="exports">
                <a href="#" onclick="exportInstrumentTypeCount()">Instrument Count</a>
            </div>
            <div class="exports">
                <a href="#" onclick="generatePatchFile()">EOS Patch</a>
            </div>
        </div>
    </div>
    
</div>

<div class="instruction" id="instructionBox2">"Perform a complete export on exit" in Vecorworks</div> <!-- Instruction box positioned below the menu -->
<div class="instruction" id="instructionBox">Use the File menu to upload an XML file.</div> <!-- Instruction box positioned below the menu -->
<div class="instruction" id="instructionBox3">Instructions on how to get XML file:</div> <!-- Instruction box positioned below the menu -->
<div class="instruction" id="instructionBox4">In Vectoworks go: Spotlight > Spotlight Settings > Spotlight Preferences > Lightwright > Use Automatic Lightwright Data Exchange > Perform a complete export on exit > OK</div> <!-- Instruction box positioned below the menu -->


<div id="searchInfo" style="display: none;">Currently Searching: <span id="searchCriteria"></span></div> <!-- Search info box -->

<table id="dataTable" class="display" style="display: none;">
    <thead>
        <tr> <!--Data Point Add-->
            <th>Channel</th>
            <th>Position</th>
            <th>Unit</th>
            <th>Purpose</th>
            <th>Type</th>
            <th>Dimmer</th>
            <th>Address</th>
            <th>Color</th>
            <th>Gobo</th>
            <th>Accessories</th>
        </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
</table>

<script>
//Version
const version = 'v1_5_2'
//Globals    
let originalData = []; // Global variable to store original data
let tableInitialized = false; // Keep track of whether the DataTable has been initialized
let instrumentData = []; //Globalize instrumeData?
let uploadedFileName = ''; // Global variable to store the uploaded file name
// Global variables for show information
let showName = '';
let designer = '';
let headElectrician = '';

function processFile() {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (!file) {
        alert('Please select an XML file.');
        return;
    }

    // Store the uploaded file name (without the extension) for later use
    uploadedFileName = file.name.replace(/\.[^/.]+$/, ""); // Remove file extension

    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(event.target.result, "text/xml");

            const instrumentData = xmlDoc.querySelector("InstrumentData");
            const instruments = instrumentData ? Array.from(instrumentData.children) : [];

            if (instruments.length <= 0) {
                alert("No instrument entries found in the XML file.");
                return;
            }

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            originalData = []; // Clear original data array

            // Start from the 6th instrument (index 5) to skip the first 5
            for (let i = 5; i < instruments.length; i++) { // Data Point Add
                const instrument = instruments[i];
                const channel = instrument.querySelector('Channel')?.textContent || '';
                const position = instrument.querySelector('Position')?.textContent || '';
                const unit = instrument.querySelector('Unit_Number')?.textContent || '';
                const purpose = instrument.querySelector('Purpose')?.textContent || '';
                const type = instrument.querySelector('Inst_Type')?.textContent || '';
                const dimmer = instrument.querySelector('Dimmer')?.textContent || '';
                const address = instrument.querySelector('Absolute_Address')?.textContent || '';
                const color = instrument.querySelector('Color')?.textContent || '';
                const gobo = instrument.querySelector('Template')?.textContent || '';

                // Parse accessories
                const accessories = [];
                const accessoriesElement = instrument.querySelector('Accessories');
                if (accessoriesElement) {
                    const accessoryItems = Array.from(accessoriesElement.children);
                    for (const accessory of accessoryItems) {
                        const accessoryType = accessory.querySelector('Inst_Type')?.textContent || 'Unknown';
                        //const accessorySymbol = accessory.querySelector('Symbol_Name')?.textContent || 'Unknown';
                        accessories.push({ type: accessoryType });
                    }
                }

                const accessoryText = accessories.map(a => `${a.type}`).join(', ');

                const row = `<tr> 
                    <td>${channel}</td>
                    <td>${position}</td>
                    <td>${unit}</td>
                    <td>${purpose}</td>
                    <td>${type}</td>
                    <td>${dimmer}</td>
                    <td>${address}</td>
                    <td>${color}</td>
                    <td>${gobo}</td>
                    <td>${accessoryText}</td>
                </tr>`; //Data Point Add
                tableBody.innerHTML += row;

                originalData.push({ channel, position, unit, purpose, type, dimmer, address, color, gobo, accessories }); //Data Point Add
            }

            document.getElementById('dataTable').style.display = 'block';
            document.getElementById('instructionBox').style.display = 'none';
            document.getElementById('instructionBox2').style.display = 'none';
            document.getElementById('instructionBox3').style.display = 'none';
            document.getElementById('instructionBox4').style.display = 'none';
            document.getElementById('searchInfo').style.display = 'none';

            if (!tableInitialized) {
                $('#dataTable').DataTable({
                    searching: false,
                    paging: false,
                    info: false,
                    order: [],
                    columnDefs: [
                        {
                            targets: 1,
                            orderData: [1, 2],
                        }
                    ]
                });
                tableInitialized = true;
            } else {
                $('#dataTable').DataTable().clear().rows.add($(tableBody).children()).draw();
            }

        } catch (error) {
            console.error("Error parsing XML file:", error);
            alert("An error occurred while processing the XML file. Please check the console for details.");
        }
    };

    reader.readAsText(file);
}


// Function to ask for show information and save it in global variables
function getShowInfo() {
    showName = prompt("Enter the name of the show:", showName || "Unnamed Show");
    designer = prompt("Enter the name of the designer:", designer || "Unknown Designer");
    headElectrician = prompt("Enter the name of the head electrician:", headElectrician || "Unknown Head Electrician");

    // Ensure variables are not empty if user clears them
    showName = showName ? showName : "Unnamed Show";
    designer = designer ? designer : "Unknown Designer";
    headElectrician = headElectrician ? headElectrician : "Unknown Head Electrician";
}


function searchByChannel() {
    const input = prompt("Enter a range (e.g., 1-5) or a list of channel numbers (e.g., 1,2,3):");
    if (input) {
        const filterValues = input.split(',').map(x => x.trim());
        const filteredData = originalData.filter(item => 
            filterValues.some(value => isInChannelRange(item.channel, value) || item.channel === value.trim())
        );

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = ''; // Clear existing rows


        filteredData.forEach(item => { //Data Point Add
            // Extract accessory types into a string, or show "N/A" if there are no accessories
            const accessoriesText = item.accessories && item.accessories.length > 0
                ? item.accessories.map(acc => acc.type || "Unknown").join("; ")
                : "N/A";
                
            const row = `<tr>
                <td>${item.channel}</td>
                <td>${item.position}</td>
                <td>${item.unit}</td>
                <td>${item.purpose}</td>
                <td>${item.type}</td>
                <td>${item.dimmer}</td>
                <td>${item.address}</td>
                <td>${item.color}</td>
                <td>${item.gobo}</td>
                <td>${accessoriesText}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        $('#dataTable').DataTable().clear().rows.add($(tableBody).children()).draw();
        
        // Display the search criteria
        document.getElementById('searchInfo').style.display = 'block';
        document.getElementById('searchCriteria').innerText = input; // Show current search criteria
    }
}

function isInChannelRange(channel, input) {
    const rangePattern = /(\d+)-(\d+)/; // Regex to match ranges like 1-5
    const match = input.match(rangePattern);
    if (match) {
        const start = parseInt(match[1]);
        const end = parseInt(match[2]);
        return parseInt(channel) >= start && parseInt(channel) <= end;
    }
    return false;
}

function searchByAddress() {
    const input = prompt("Enter a range (e.g., 100-200) or a list of addresses (e.g., 100,150,200):");
    if (input) {
        const filterValues = input.split(',').map(x => x.trim());
        const filteredData = originalData.filter(item => 
            filterValues.some(value => isInAddressRange(item.address, value) || item.address === value.trim())
        );

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = ''; // Clear existing rows


        filteredData.forEach(item => { //Data Point Add
            // Extract accessory types into a string, or show "N/A" if there are no accessories
            const accessoriesText = item.accessories && item.accessories.length > 0
                ? item.accessories.map(acc => acc.type || "Unknown").join("; ")
                : "N/A";

            const row = `<tr>
                <td>${item.channel}</td>
                <td>${item.position}</td>
                <td>${item.unit}</td>
                <td>${item.purpose}</td>
                <td>${item.type}</td>
                <td>${item.dimmer}</td>
                <td>${item.address}</td>
                <td>${item.color}</td>
                <td>${item.gobo}</td>
                <td>${accessoriesText}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        $('#dataTable').DataTable().clear().rows.add($(tableBody).children()).draw();
        
        // Display the search criteria
        document.getElementById('searchInfo').style.display = 'block';
        document.getElementById('searchCriteria').innerText = input; // Show current search criteria
    }
}

function isInAddressRange(address, input) {
    const rangePattern = /(\d+)-(\d+)/; // Regex to match ranges like 100-200
    const match = input.match(rangePattern);
    if (match) {
        const start = parseInt(match[1]);
        const end = parseInt(match[2]);
        return parseInt(address) >= start && parseInt(address) <= end;
    }
    return false;
}

async function searchByPosition() {
    const uniquePositions = [...new Set(originalData.map(item => item.position))]; // Get unique positions

    // Create the checkboxes dynamically
    let checkboxHTML = uniquePositions.map(position => {
        return `<label><input type="checkbox" value="${position}"> ${position}</label><br>`;
    }).join('');

    // Display the user selection box at the top
    const userSelectionBox = createSelectionBox(checkboxHTML);
    document.body.insertBefore(userSelectionBox, document.getElementById('dataTable').parentNode); // Insert above the table

    // Wait for the user to make their selection
    const userSelection = await promptUserToSelectPositions(userSelectionBox, checkboxHTML);

    if (userSelection) {
        const selectedPositions = userSelection.split(',').map(position => position.trim());
        const filteredData = originalData.filter(item => 
            selectedPositions.includes(item.position)
        );

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = ''; // Clear existing rows

        filteredData.forEach(item => { // Data Point Add
            // Extract accessory types into a string, or show "N/A" if there are no accessories
            const accessoriesText = item.accessories && item.accessories.length > 0
                ? item.accessories.map(acc => acc.type || "Unknown").join("; ")
                : "N/A";

            const row = `<tr>
                <td>${item.channel}</td>
                <td>${item.position}</td>
                <td>${item.unit}</td>
                <td>${item.purpose}</td>
                <td>${item.type}</td>
                <td>${item.dimmer}</td>
                <td>${item.address}</td>
                <td>${item.color}</td>
                <td>${item.gobo}</td>
                <td>${accessoriesText}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        $('#dataTable').DataTable().clear().rows.add($(tableBody).children()).draw();
        
        // Display the search criteria
        document.getElementById('searchInfo').style.display = 'block';
        document.getElementById('searchCriteria').innerText = `Positions: ${userSelection}`; // Show current search criteria
    }
}

function createSelectionBox(checkboxHTML) {
    const box = document.createElement('div');
    box.id = 'selectionBox';
    box.innerHTML = `
        <h3>Select Positions</h3>
        <div>${checkboxHTML}</div>
        <button id="submitSelection">Submit</button>
    `;
    return box;
}

function promptUserToSelectPositions(userSelectionBox, checkboxHTML) {
    return new Promise((resolve) => {
        document.getElementById('submitSelection').addEventListener('click', () => {
            const selectedPositions = [...userSelectionBox.querySelectorAll('input[type="checkbox"]:checked')].map(input => input.value);
            resolve(selectedPositions.join(','));

            // Remove the selection box after submission
            document.body.removeChild(userSelectionBox);
        });
    });
}




function resetSearch() {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = ''; // Clear existing rows

    // Re-add all original data entries
    originalData.forEach(item => {
        // Extract accessory types into a string, or show "N/A" if there are no accessories
        const accessoriesText = item.accessories && item.accessories.length > 0
            ? item.accessories.map(acc => acc.type || "Unknown").join("; ")
            : "";

        const row = `<tr>
            <td>${item.channel}</td>
            <td>${item.position}</td>
            <td>${item.unit}</td>
            <td>${item.purpose}</td>
            <td>${item.type}</td>
            <td>${item.dimmer}</td>
            <td>${item.address}</td>
            <td>${item.color}</td>
            <td>${item.gobo}</td>
            <td>${accessoriesText}</td>
        </tr>`; //Data Point Add
        tableBody.innerHTML += row;
    });

    // Redraw the DataTable
    $('#dataTable').DataTable().clear().rows.add($(tableBody).children()).draw();

    // Hide search info
    document.getElementById('searchInfo').style.display = 'none';
}


function exportChannelHookup() {
    function createHeader(pageNumber) { //Data Point Add
        return `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <h1 style="margin: 0;">Channel Hookup ${showName}</h1>
                <div style="text-align: center; font-size: 10px;">Designer: ${designer} | HE: ${headElectrician}</div>
                <div style="text-align: right; font-size: 10px;">Page ${pageNumber}...</div>
            </div>
            <div style="font-weight: bold; display: flex; justify-content: space-between; width: 100%;">
                <span style="width: 12%;">Channel</span>
                <span style="width: 12%;">Position</span>
                <span style="width: 12%;">Unit</span>
                <span style="width: 12%;">Purpose</span>
                <span style="width: 12%;">Type</span>
                <span style="width: 12%;">Address</span>
                <span style="width: 12%;">Color</span>
                <span style="width: 12%;">Gobo</span>
                <span style="width: 12%;">Accessories</span>
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>
        `;
    }

    function createFooter(pageNumber) {
        return `
            <div style="text-align: center; font-size: 8px; margin-top: 20px;">
                <p>This was generated using Light Rewrite Web ${version}</p>
            </div>
        `;
    }

    const data = originalData.sort((a, b) => parseInt(a.channel) - parseInt(b.channel));

    if (data.length === 0) {
        alert('No instrument data available for export.');
        return;
    }

    const pdfDiv = document.createElement('div');
    pdfDiv.style.width = '100%';
    pdfDiv.style.fontSize = '12px';

    const instrumentsPerPage = 20;
    let pageNumber = 1;

    for (let i = 0; i < data.length; i += instrumentsPerPage) {
        const chunk = data.slice(i, i + instrumentsPerPage);
        const headerContent = createHeader(pageNumber);

        let pdfContent = '';
        chunk.forEach((instrument) => {
            // Extract accessories if they exist and only display the type
            const accessoriesText = instrument.accessories && instrument.accessories.length > 0
                ? instrument.accessories.map(acc => acc.type || "Unknown").join("; ")
                : "N/A";

            pdfContent += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; width: 100%;">
                <span style="width: 12%;">${instrument.channel}</span>
                <span style="width: 12%;">${instrument.position}</span>
                <span style="width: 12%;">${instrument.unit}</span>
                <span style="width: 12%;">${instrument.purpose}</span>
                <span style="width: 12%;">${instrument.type}</span>
                <span style="width: 12%;">${instrument.address}</span>
                <span style="width: 12%;">${instrument.color}</span>
                <span style="width: 12%;">${instrument.gobo}</span>
                <span style="width: 12%;">${accessoriesText}</span>
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>`;
        });//Data Point Add

        const footerContent = createFooter(pageNumber);
        pdfDiv.innerHTML += headerContent + pdfContent + footerContent;

        if (i + instrumentsPerPage < data.length) {
            pdfDiv.innerHTML += '<div style="page-break-after: always;"></div>';
        }

        pageNumber++;
    }

    const pdfOptions = {
        margin:       0.5,
        filename:     `${uploadedFileName}_channel_hookup.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
    };

    html2pdf().from(pdfDiv).set(pdfOptions).save();
}

function exportInstrumentSchedule() {
    function createHeader(position, pageNumber) { //Data Point Add
        return `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <h1 style="margin: 0;">Instrument Schedule</h1>
                <div style="text-align: center; font-size: 10px;">Designer: ${designer} | HE: ${headElectrician}</div>
                <div style="text-align: right; font-size: 10px;">Page ${pageNumber}...</div>
            </div>
            <div style="text-align: left; font-size: 15px; font-weight: bold">Position: ${position}</div>
            <div style="font-weight: bold; display: flex; justify-content: space-between; width: 100%; margin-top: 10px;">
                <span style="width: 12%;">Unit</span>
                <span style="width: 12%;">Purpose</span>
                <span style="width: 12%;">Type</span>
                <span style="width: 12%;">Channel</span>
                <span style="width: 12%;">Address</span>
                <span style="width: 12%;">Color</span>
                <span style="width: 12%;">Gobo</span>
                <span style="width: 12%;">Accessories</span>
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>
        `;
    }

    function createFooter(pageNumber) {
        return `
            <div style="text-align: center; font-size: 8px; margin-top: 20px;">
                <p>This was generated using Light Rewrite Web ${version}</p>
            </div>
        `;
    }

    const data = originalData.sort((a, b) => {
        if (a.position === b.position) {
            return parseInt(a.unit) - parseInt(b.unit);
        }
        return a.position.localeCompare(b.position);
    });

    if (data.length === 0) {
        alert('No instrument data available for export.');
        return;
    }

    const pdfDiv = document.createElement('div');
    pdfDiv.style.width = '100%';
    pdfDiv.style.fontSize = '12px';

    const instrumentsPerPage = 14; // Limit to 15 instruments per page
    let pageNumber = 1;
    let lastPosition = ''; // Track the last position to detect changes
    let instrumentsInPosition = 0; // Track the number of instruments on the current page

    for (let i = 0; i < data.length; i++) {
        const instrument = data[i];

        // If the position is different, or we have reached the instrument limit per page, 
        // add a page break and reset the instrument count
        if (instrument.position !== lastPosition || instrumentsInPosition === instrumentsPerPage) {
            // If it's not the first position, add a page break
            if (lastPosition !== '') {
                pdfDiv.innerHTML += '<div style="page-break-after: always;"></div>';
            }

            // Add the header for the new position
            pdfDiv.innerHTML += createHeader(instrument.position, pageNumber);
            lastPosition = instrument.position; // Update last position
            instrumentsInPosition = 0; // Reset counter for instruments

            pageNumber++; // Increment page number
        }

        // Add the instrument to the page
        const accessoriesText = instrument.accessories && instrument.accessories.length > 0
            ? instrument.accessories.map(acc => acc.type || "Unknown").join("; ")
            : "N/A";

        pdfDiv.innerHTML += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; width: 100%;">
            <span style="width: 12%;">${instrument.unit}</span>
            <span style="width: 12%;">${instrument.purpose}</span>
            <span style="width: 12%;">${instrument.type}</span>
            <span style="width: 12%;">${instrument.channel}</span>
            <span style="width: 12%;">${instrument.address}</span>
            <span style="width: 12%;">${instrument.color}</span>
            <span style="width: 12%;">${instrument.gobo}</span>
            <span style="width: 12%;">${accessoriesText}</span>
        </div>
        <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>`; //Data Point Add

        // Increment instrument count for the current page
        instrumentsInPosition++;
         // If we have reached the limit for the page, insert a page break and footer
         if (instrumentsInPosition === instrumentsPerPage) {
            // Add the footer at the bottom of the page after the instruments
            pdfDiv.innerHTML += createFooter(pageNumber);
        }

        // If it's the last instrument for this position or last in data, insert the page break
        if (i === data.length - 1 || data[i + 1].position !== instrument.position) {
            const footerContent = createFooter(pageNumber);
            pdfDiv.innerHTML += footerContent;
        }
    }

    const pdfOptions = {
        margin:       0.5,
        filename:     `${uploadedFileName}_instrument_schedule.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
    };

    html2pdf().from(pdfDiv).set(pdfOptions).save();
}

function exportColorCount() {
    function createHeader(pageNumber) { //Data Point Add
        return `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <h1 style="margin: 0;">Color Count ${showName}</h1>
                <div style="text-align: center; font-size: 10px;">Designer: ${designer} | HE: ${headElectrician}</div>
                <div style="text-align: right; font-size: 10px;">Page ${pageNumber}...</div>
            </div>
            <div style="font-weight: bold; display: flex; justify-content: space-between; width: 100%;">
                <span style="width: 45%;">Color</span>
                <span style="width: 45%;">Instrument Type</span>
                <span style="width: 10%;">Count</span>
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>
        `;
    }

    function createFooter(pageNumber) {
        return `
            <div style="text-align: center; font-size: 8px; margin-top: 20px;">
                <p>This was generated using Light Rewrite Web ${version}</p>
            </div>
        `;
    }

    // Create a map to count colors by instrument type (using "type" field)
    const colorCount = {};

    originalData.forEach(instrument => {
        const color = instrument.color || "Unknown";  // Default to "Unknown" if no color
        const instType = instrument.type || "Unknown";  // Use "type" for instrument type

        // Debugging: Log the inst_type and color for each instrument
        console.log(`Instrument: ${instrument.channel}, Color: ${color}, Instrument Type: ${instType}`);

        if (!colorCount[color]) {
            colorCount[color] = {};
        }

        if (!colorCount[color][instType]) {
            colorCount[color][instType] = 0;
        }

        colorCount[color][instType]++;
    });

    // Flatten the colorCount object into an array for easy PDF generation
    const colorReport = [];
    for (const color in colorCount) {
        for (const instType in colorCount[color]) {
            colorReport.push({
                color: color,
                instType: instType,
                count: colorCount[color][instType]
            });
        }
    }

    // Sort the report alphabetically by color and instrument type
    colorReport.sort((a, b) => {
        if (a.color === b.color) {
            return a.instType.localeCompare(b.instType);
        }
        return a.color.localeCompare(b.color);
    });

    if (colorReport.length === 0) {
        alert('No color data available for export.');
        return;
    }

    const pdfDiv = document.createElement('div');
    pdfDiv.style.width = '100%';
    pdfDiv.style.fontSize = '12px';

    const itemsPerPage = 20;
    let pageNumber = 1;

    for (let i = 0; i < colorReport.length; i += itemsPerPage) {
        const chunk = colorReport.slice(i, i + itemsPerPage);
        const headerContent = createHeader(pageNumber);

        let pdfContent = '';
        chunk.forEach((report) => {
            pdfContent += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; width: 100%;">
                <span style="width: 45%;">${report.color}</span>
                <span style="width: 45%;">${report.instType}</span>
                <span style="width: 10%;">${report.count}</span>
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>`;
        });

        const footerContent = createFooter(pageNumber);
        pdfDiv.innerHTML += headerContent + pdfContent + footerContent;

        if (i + itemsPerPage < colorReport.length) {
            pdfDiv.innerHTML += '<div style="page-break-after: always;"></div>';
        }

        pageNumber++;
    }

    const pdfOptions = {
        margin:       0.5,
        filename:     `${uploadedFileName}_color_count.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
    };

    html2pdf().from(pdfDiv).set(pdfOptions).save();
}

function exportInstrumentTypeCount() {
    function createHeader(pageNumber) {
        return `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <h1 style="margin: 0;">Instrument Type Count ${showName}</h1>
                <div style="text-align: center; font-size: 10px;">Designer: ${designer} | HE: ${headElectrician}</div>
                <div style="text-align: right; font-size: 10px;">Page ${pageNumber}...</div>
            </div>
            <div style="font-weight: bold; display: flex; justify-content: space-between; width: 100%;">
                <span style="width: 80%;">Instrument Type</span>
                <span style="width: 20%;">Count</span>
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>
        `;
    }

    function createFooter(pageNumber) {
        return `
            <div style="text-align: center; font-size: 8px; margin-top: 20px;">
                <p>This was generated using Light Rewrite Web ${version}</p>
            </div>
        `;
    }

    // Create a map to count the instrument types
    const typeCount = {};

    originalData.forEach(instrument => {
        const instType = instrument.type || "Unknown";  // Use "type" field for instrument type

        // Debugging: Log the instrument type for each instrument
        console.log(`Instrument: ${instrument.channel}, Instrument Type: ${instType}`);

        if (!typeCount[instType]) {
            typeCount[instType] = 0;
        }

        typeCount[instType]++;
    });

    // Convert the typeCount object into an array for easy PDF generation
    const typeReport = [];
    for (const instType in typeCount) {
        typeReport.push({
            instType: instType,
            count: typeCount[instType]
        });
    }

    // Sort the report alphabetically by instrument type
    typeReport.sort((a, b) => a.instType.localeCompare(b.instType));

    if (typeReport.length === 0) {
        alert('No instrument type data available for export.');
        return;
    }

    const pdfDiv = document.createElement('div');
    pdfDiv.style.width = '100%';
    pdfDiv.style.fontSize = '12px';

    const itemsPerPage = 20;
    let pageNumber = 1;

    for (let i = 0; i < typeReport.length; i += itemsPerPage) {
        const chunk = typeReport.slice(i, i + itemsPerPage);
        const headerContent = createHeader(pageNumber);

        let pdfContent = '';
        chunk.forEach((report) => {
            pdfContent += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; width: 100%;">
                <span style="width: 80%;">${report.instType}</span>
                <span style="width: 20%;">${report.count}</span>
            </div>
            <hr style="margin: 5px 0; border: none; border-top: 1px solid #000;"/>`;
        });

        const footerContent = createFooter(pageNumber);
        pdfDiv.innerHTML += headerContent + pdfContent + footerContent;

        if (i + itemsPerPage < typeReport.length) {
            pdfDiv.innerHTML += '<div style="page-break-after: always;"></div>';
        }

        pageNumber++;
    }

    const pdfOptions = {
        margin:       0.5,
        filename:     `${uploadedFileName}_instrument_type_count.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'landscape' }
    };

    html2pdf().from(pdfDiv).set(pdfOptions).save();
}

function generatePatchFile() {
    if (!originalData || originalData.length === 0) {
        alert("No data available to generate the patch file.");
        return;
    }

    // Define the headers for the ETC EOS Patch file
    let patchFileContent = "Purpose\tChannel\tAddress\tInstrument Type\tDevice Type\n";

    // Populate each row based on the parsed instrument data
    for (const instrument of originalData) {
        const purpose = instrument.purpose || "N/A";
        const channel = instrument.channel || "N/A";
        const address = instrument.address || "N/A";
        const instType = instrument.type || "N/A";
        const deviceType = "Light"; // Static value as per example output

        // Append each row to the content
        patchFileContent += `${purpose}\t${channel}\t${address}\t${instType}\t${deviceType}\n`;
    }

    // Create a blob and download the file
    const blob = new Blob([patchFileContent], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${uploadedFileName}_Patch.txt`;
    link.click();
}

function populateAddressFromDimmer() {
    if (!originalData || originalData.length === 0) {
        alert("No data available to populate addresses.");
        return;
    }

    // Prompt the user to input the starting universe for dimmer 1
    let startingUniverse = parseInt(prompt("Enter the starting universe for dimmer 1:", "1"), 10);
    if (isNaN(startingUniverse) || startingUniverse < 1) {
        alert("Invalid universe number. Please enter a valid number starting from 1.");
        return;
    }

    // Loop through each instrument and assign dimmer value to address if address is empty or 0
    for (const instrument of originalData) {
        if ((!instrument.address || instrument.address === "0") && instrument.dimmer) {
            const dimmerValue = parseInt(instrument.dimmer, 10);

            if (!isNaN(dimmerValue) && dimmerValue > 0) {
                // Calculate the correct address using the formula
                const address = dimmerValue + ((startingUniverse - 1) * 512);
                instrument.address = address.toString();
            }
        }
    }
    resetSearch()
}






</script>

</body>
</html>
